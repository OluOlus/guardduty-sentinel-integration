{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# AWS GuardDuty Threat Hunting Workbook\n\nAdvanced threat hunting and investigation workbook for AWS GuardDuty findings.\n\n---"
      },
      "name": "Header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "timeRange",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 604800000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 2592000000
                }
              ]
            }
          },
          {
            "id": "threatType",
            "version": "KqlParameterItem/1.0",
            "name": "ThreatType",
            "type": 2,
            "isRequired": false,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "GuardDutyNormalized()\n| where TimeGenerated {TimeRange}\n| extend ThreatCategory = case(\n    Type contains \"Trojan\", \"Malware\",\n    Type contains \"Backdoor\", \"Malware\", \n    Type contains \"Cryptocurrency\", \"CryptoCurrency\",\n    Type contains \"Recon\", \"Reconnaissance\",\n    Type contains \"Exfiltration\", \"DataExfiltration\",\n    Type contains \"Impact\", \"Impact\",\n    \"Other\"\n)\n| distinct ThreatCategory\n| sort by ThreatCategory asc",
            "value": [],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "*"
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "HuntingParameters"
    },
    {
      "type": 1,
      "content": {
        "json": "## Cryptocurrency Mining Investigation"
      },
      "name": "CryptoMiningHeader"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "GuardDutyNormalized()\n| where TimeGenerated {TimeRange}\n| where Type contains \"CryptoCurrency\"\n| extend \n    MiningPool = case(\n        DnsRequestDomain contains \"pool\", DnsRequestDomain,\n        RemoteIpAddress != \"\", RemoteIpAddress,\n        \"Unknown\"\n    )\n| summarize \n    FindingCount = count(),\n    UniqueInstances = dcount(InstanceId),\n    Countries = make_set(RemoteIpCountry),\n    FirstSeen = min(EventFirstSeen),\n    LastSeen = max(EventLastSeen),\n    MaxSeverity = max(Severity)\n    by MiningPool, AccountId\n| sort by FindingCount desc",
        "size": 0,
        "title": "Cryptocurrency Mining Activity by Pool/IP",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "MaxSeverity",
              "formatter": 8,
              "formatOptions": {
                "palette": "redBright"
              }
            }
          ]
        }
      },
      "name": "CryptoMiningAnalysis"
    },
    {
      "type": 1,
      "content": {
        "json": "## Malware and Backdoor Analysis"
      },
      "name": "MalwareHeader"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "GuardDutyNormalized()\n| where TimeGenerated {TimeRange}\n| where Type has_any (\"Trojan\", \"Backdoor\", \"Malware\")\n| extend \n    MalwareFamily = case(\n        Type contains \"Trojan:EC2/DNSDataExfiltration\", \"DNS Exfiltration Trojan\",\n        Type contains \"Trojan:EC2/DriveBySourceTraffic\", \"Drive-by Download Trojan\",\n        Type contains \"Backdoor:EC2/XORDDOS\", \"XOR DDoS Backdoor\",\n        Type contains \"Backdoor:EC2/Spambot\", \"Spambot Backdoor\",\n        extract(@\"([^:]+):.*\", 1, Type)\n    )\n| summarize \n    Infections = count(),\n    AffectedInstances = make_set(InstanceId),\n    SourceIPs = make_set(RemoteIpAddress),\n    Countries = make_set(RemoteIpCountry),\n    AvgSeverity = avg(Severity)\n    by MalwareFamily, AccountId, Region\n| sort by Infections desc",
        "size": 0,
        "title": "Malware Family Distribution and Impact",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "MalwareAnalysis"
    },
    {
      "type": 1,
      "content": {
        "json": "## Network-based Threat Hunting"
      },
      "name": "NetworkThreatHeader"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "GuardDutyNormalized()\n| where TimeGenerated {TimeRange}\n| where isnotempty(RemoteIpAddress)\n| summarize \n    TotalConnections = sum(Count),\n    UniqueFindings = count(),\n    ThreatTypes = make_set(Type),\n    AffectedInstances = make_set(InstanceId),\n    TimeSpan = max(EventLastSeen) - min(EventFirstSeen),\n    MaxSeverity = max(Severity)\n    by RemoteIpAddress, RemoteIpCountry\n| extend \n    RiskScore = case(\n        MaxSeverity >= 8.0 and TotalConnections > 100, 95,\n        MaxSeverity >= 7.0 and TotalConnections > 50, 85,\n        MaxSeverity >= 6.0 and TotalConnections > 20, 75,\n        MaxSeverity >= 5.0, 65,\n        50\n    )\n| sort by RiskScore desc, TotalConnections desc\n| take 25",
        "size": 0,
        "title": "High-Risk External IP Addresses",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "RiskScore",
              "formatter": 8,
              "formatOptions": {
                "palette": "redBright"
              }
            },
            {
              "columnMatch": "MaxSeverity",
              "formatter": 1,
              "numberFormat": {
                "unit": 0,
                "options": {
                  "maximumFractionDigits": 1
                }
              }
            }
          ]
        }
      },
      "name": "NetworkThreatAnalysis"
    },
    {
      "type": 1,
      "content": {
        "json": "## Instance Compromise Investigation"
      },
      "name": "InstanceCompromiseHeader"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "GuardDutyNormalized()\n| where TimeGenerated {TimeRange}\n| where isnotempty(InstanceId)\n| summarize \n    ThreatCount = count(),\n    ThreatTypes = make_set(Type),\n    MaxSeverity = max(Severity),\n    ExternalIPs = make_set(RemoteIpAddress),\n    Countries = make_set(RemoteIpCountry),\n    FirstCompromise = min(EventFirstSeen),\n    LastActivity = max(EventLastSeen),\n    TotalEvents = sum(Count)\n    by InstanceId, AccountId, Region, ResourceType\n| extend \n    CompromiseDuration = LastActivity - FirstCompromise,\n    ThreatDiversity = array_length(ThreatTypes),\n    GeographicSpread = array_length(Countries)\n| where ThreatCount > 1 or MaxSeverity >= 7.0\n| sort by ThreatCount desc, MaxSeverity desc",
        "size": 0,
        "title": "Potentially Compromised Instances",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "MaxSeverity",
              "formatter": 8,
              "formatOptions": {
                "palette": "redBright"
              }
            },
            {
              "columnMatch": "ThreatDiversity",
              "formatter": 8,
              "formatOptions": {
                "palette": "orange"
              }
            }
          ]
        }
      },
      "name": "InstanceCompromiseAnalysis"
    },
    {
      "type": 1,
      "content": {
        "json": "## DNS-based Threat Hunting"
      },
      "name": "DNSThreatHeader"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "GuardDutyNormalized()\n| where TimeGenerated {TimeRange}\n| where isnotempty(DnsRequestDomain)\n| extend \n    DomainCategory = case(\n        DnsRequestDomain contains \"pool\" or DnsRequestDomain contains \"mining\", \"Mining Pool\",\n        DnsRequestDomain contains \"tor\" or DnsRequestDomain contains \"onion\", \"Anonymization\",\n        DnsRequestDomain contains \"dga\" or DnsRequestDomain matches regex @\"[a-z]{10,}\\.com\", \"DGA Suspected\",\n        DnsRequestDomain contains \"c2\" or DnsRequestDomain contains \"command\", \"C2 Infrastructure\",\n        \"Suspicious Domain\"\n    )\n| summarize \n    QueryCount = sum(Count),\n    UniqueInstances = dcount(InstanceId),\n    ThreatTypes = make_set(Type),\n    MaxSeverity = max(Severity),\n    Accounts = make_set(AccountId)\n    by DnsRequestDomain, DomainCategory\n| sort by QueryCount desc\n| take 30",
        "size": 0,
        "title": "Suspicious DNS Activity Analysis",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "DomainCategory",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Mining Pool",
                    "representation": "orange"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "C2 Infrastructure", 
                    "representation": "redBright"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "DGA Suspected",
                    "representation": "red"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "DNSThreatAnalysis"
    },
    {
      "type": 1,
      "content": {
        "json": "## Timeline Analysis for Investigation"
      },
      "name": "TimelineHeader"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "GuardDutyNormalized()\n| where TimeGenerated {TimeRange}\n| where Severity >= 6.0\n| extend \n    ThreatCategory = case(\n        Type contains \"Trojan\", \"Malware\",\n        Type contains \"Backdoor\", \"Malware\", \n        Type contains \"Cryptocurrency\", \"CryptoCurrency\",\n        Type contains \"Recon\", \"Reconnaissance\",\n        Type contains \"Exfiltration\", \"DataExfiltration\",\n        \"Other\"\n    )\n| make-series FindingCount = count() default = 0 on TimeGenerated step 1h by ThreatCategory\n| render timechart",
        "size": 0,
        "title": "Threat Activity Timeline (Severity >= 6.0)",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "ThreatTimeline"
    }
  ],
  "fallbackResourceIds": [],
  "fromTemplateId": "sentinel-GuardDutyThreatHunting",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}