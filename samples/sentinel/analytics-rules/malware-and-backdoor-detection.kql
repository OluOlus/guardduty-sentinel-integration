// Malware and Backdoor Detection Analytics Rule
// Detects GuardDuty findings related to malware, trojans, and backdoors
// Rule Type: Scheduled
// Frequency: 10 minutes
// Query Period: 10 minutes

let LookbackPeriod = 10m;
let MalwareTypes = dynamic([
    "Trojan", "Backdoor", "Rootkit", "Malware"
]);

GuardDutyNormalized()
| where TimeGenerated >= ago(LookbackPeriod)
| where not(Archived)
| where Type has_any (MalwareTypes)
| extend
    MalwareFamily = case(
        Type contains "Trojan:EC2/DNSDataExfiltration", "DNS Exfiltration Trojan",
        Type contains "Trojan:EC2/DriveBySourceTraffic", "Drive-by Download Trojan",
        Type contains "Trojan:EC2/DropPoint", "Drop Point Trojan",
        Type contains "Backdoor:EC2/XORDDOS", "XOR DDoS Backdoor",
        Type contains "Backdoor:EC2/Spambot", "Spambot Backdoor",
        Type contains "Backdoor:EC2/C&CActivity", "Command & Control Backdoor",
        extract(@"([^:]+):.*", 1, Type)
    ),
    ThreatLevel = case(
        Severity >= 8.5, "Critical",
        Severity >= 7.0, "High", 
        Severity >= 5.0, "Medium",
        "Low"
    ),
    InfectionVector = case(
        ActionType == "DNS_REQUEST", "DNS-based",
        ActionType == "NETWORK_CONNECTION", "Network-based",
        ActionType == "PORT_PROBE", "Port Scanning",
        "Unknown"
    )
| extend
    RemediationActions = pack_array(
        "Isolate affected instance immediately",
        "Capture memory dump for forensic analysis", 
        "Review CloudTrail logs for lateral movement",
        "Scan other instances in the same VPC",
        "Update security groups to block malicious IPs",
        iff(isnotempty(RemoteIpAddress), strcat("Block IP address: ", RemoteIpAddress), ""),
        iff(isnotempty(DnsRequestDomain), strcat("Block domain: ", DnsRequestDomain), "")
    )
| project
    TimeGenerated,
    FindingId,
    AccountId,
    Region,
    Severity,
    ThreatLevel,
    Type,
    MalwareFamily,
    Title,
    Description,
    ResourceType,
    InstanceId,
    RemoteIpAddress,
    RemoteIpCountry,
    DnsRequestDomain,
    InfectionVector,
    ThreatNames,
    RemediationActions,
    Count,
    EventFirstSeen,
    EventLastSeen,
    RawJson
| sort by Severity desc, TimeGenerated desc